---
description: thatopen framework guidelines
alwaysApply: false
---
ThatOpen Framework Guidelines (BIM Engine)

## ⚠️ CRITICAL: Version Changes

**BEFORE making ANY changes to versions of `web-ifc`, `@thatopen/*` packages, `three.js`, or related Three.js libraries, you MUST:**

1. **Read the ThatOpen Migration Guide**: https://docs.thatopen.com/migration
2. **Check version compatibility**: All ThatOpen packages and their peer dependencies (especially `web-ifc` and `three.js`) must be compatible
3. **Verify peer dependency requirements**: Check `package-lock.json` for the required versions (e.g., `web-ifc >= 0.0.72` for ThatOpen Components 3.2.x)
4. **Update WASM path**: If `web-ifc` version changes, update the WASM path in loader configuration to match the new version
5. **Never mix old and new library versions**: All ThatOpen packages must be upgraded together

**Key Points from Migration Docs:**
- All versions of the library should use the same `web-ifc` version
- You can't combine old and new libraries
- Check peer dependencies (watch out for `three.js` version requirements)
- The correct `web-ifc` version can be found in the migration guide and in `package-lock.json` peer dependencies

Core Principles

The application uses @thatopen/components (Engine) and @thatopen/ui (Web Components).

1. Lifecycle Management (CRITICAL)

Initialization: Always initialize the viewer inside onMount (Svelte). The 3D context does not exist during SSR (Server Side Rendering).

Disposal: You MUST implement a dispose() or cleanup function in onDestroy.

Call components.dispose().

Remove event listeners.

Nullify references to avoid memory leaks (WebGL contexts are heavy).

2. UI Integration

Web Components: Use @thatopen/ui tags directly in Svelte HTML (e.g., <bim-viewport>, <bim-grid>).

Bindings: To interact with UI components via code, use bind:this.

Styling: Do not try to style <bim-*> components with global CSS. Use their exposed CSS variables or the BUI.Manager API.

3. Data Handling

WASM: Configure the IfcLoader to point to a valid CDN or local static asset folder for web-ifc.wasm.

Fragments: Always convert IFC to Fragments for display. Do not try to render raw IFC geometry with Three.js primitives manually.

Coordinate System: Always ensure COORDINATE_TO_ORIGIN = true in loader settings to prevent floating point jitter. Implement "Global Shift" logic to align multiple models (Arch + Structural).

4. Error Patterns to Avoid

SSR Error: "window is not defined". -> Fix: Wrap viewer logic in if (browser) { ... } or onMount.

Context Lost: "WebGL context lost". -> Fix: Ensure only ONE instance of the viewer exists per page.
